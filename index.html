<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Û•Ø±Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ ØªØ§Ù‚ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•Ú©Ø§Ù†</title>

    <!-- PWA -->
    <meta name="theme-color" content="#111729">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ØªØ§Ù‚ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•Ú©Ø§Ù†">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @font-face {
            font-family: 'Rabar38';
            src: local('Rabar_038'); 
        }
        :root {
            --bg-main: #111729;
            --bg-secondary: #262E48;
            --color-accent: #6466E9;
            --color-success: #4caf50;
            --color-error: #e96464;
            --text-color: #ffffff;
            --text-muted: #a0aabf;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rabar38', Arial, sans-serif; }
        body { background-color: var(--bg-main); color: var(--text-color); height: 100vh; overflow: hidden; }
        
        #login-view { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-box { background-color: var(--bg-secondary); padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .login-box h2 { margin-bottom: 20px; color: var(--color-accent); }
        .input-group { margin-bottom: 15px; text-align: right; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-muted); }
        .input-group input, .input-group select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #3b4560; background: var(--bg-main); color: #fff; outline: none; }
        .input-group input:focus, .input-group select:focus { border-color: var(--color-accent); }
        .btn { width: 100%; padding: 10px; background-color: var(--color-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background-color: #4f51c7; }
        
        #app-view { display: none; height: 100vh; flex: 1; }
        #app-view.shown { display: flex; }
        #sidebar { width: 250px; background-color: var(--bg-secondary); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .profile-area { text-align: center; margin-bottom: 30px; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-accent); margin-bottom: 10px; }
        .nav-btn { background: transparent; color: var(--text-color); border: none; padding: 15px; text-align: right; width: 100%; cursor: pointer; border-radius: 6px; margin-bottom: 5px; font-size: 16px; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { background-color: var(--color-accent); }
        .logout-btn { margin-top: auto; background-color: var(--color-error); }
        .logout-btn:hover { background-color: #c74f4f; }
        
        #content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        .section-title { margin-bottom: 20px; font-size: 24px; border-bottom: 2px solid var(--bg-secondary); padding-bottom: 10px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .stat-card { background-color: var(--bg-secondary); padding: 30px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--color-accent); }
        .stat-card h3 { color: var(--text-muted); font-size: 18px; margin-bottom: 10px; }
        .stat-card p { font-size: 36px; font-weight: bold; }
        
        .table-container { background-color: var(--bg-secondary); padding: 20px; border-radius: 12px; }
        table.data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table.data-table th, table.data-table td { padding: 12px; text-align: right; border-bottom: 1px solid #3b4560; }
        table.data-table th { color: var(--color-accent); }
        .filter-area { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-area input, .filter-area select { flex: 1; padding: 10px; border-radius: 6px; border: none; background: var(--bg-main); color: #fff; }
        
        .sectors-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .sector-card { background-color: var(--bg-secondary); padding: 20px; border-radius: 12px; border-right: 4px solid var(--color-accent); }
        .sector-card h4 { margin-bottom: 10px; color: var(--color-accent); font-size: 20px;}
        .sector-details { display: flex; justify-content: space-between; margin-bottom: 15px; color: var(--text-muted); }

        .print-controls { background-color: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
        .print-controls select { padding: 10px; border-radius: 6px; background: var(--bg-main); color: #fff; border: 1px solid var(--color-accent); width: 200px; font-size: 16px; }
        
        #print-document { background: white; color: black; padding: 40px; border-radius: 8px; margin: 0 auto; max-width: 900px; }
        .doc-header { background-color: #f8cecc; border: 2px solid #000; border-radius: 12px; text-align: center; padding: 20px; margin-bottom: 25px; }
        .doc-header h2 { margin-bottom: 10px; font-size: 22px; }
        .doc-header h3 { margin-bottom: 5px; font-size: 18px; }
        
        .doc-subheader { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .box-green { background-color: #d5e8d4; border: 2px solid #000; padding: 15px 40px; border-radius: 6px; font-size: 20px; font-weight: bold; }
        .box-yellow { background-color: #fff2cc; border: 2px solid #000; padding: 15px 40px; border-radius: 6px; font-size: 20px; font-weight: bold; }
        
        .doc-table { width: 100%; border-collapse: collapse; border: 2px solid #000; margin-bottom: 30px; font-size: 15px; }
        .doc-table td { border: 1px solid #000; text-align: center; padding: 15px 5px; height: 90px; vertical-align: middle; width: 33.33%; }
        
        .grade-11 { background-color: #f8cecc; } 
        .grade-10 { background-color: #dae8fc; } 
        .grade-12 { background-color: #ffffff; } 
        .grade-empty { background-color: #f0f0f0; } 

        .doc-footer { display: flex; justify-content: space-between; align-items: flex-end; }
        .footer-box { background-color: #dae8fc; border: 2px solid #000; padding: 15px 30px; border-radius: 6px; text-align: center; font-size: 16px; font-weight: bold; line-height: 1.8; }
        .manager-box { padding: 20px 50px; }

        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { padding: 15px 25px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); animation: slideIn 0.4s ease-out forwards, fadeOut 0.4s ease-in 2.6s forwards; }
        .toast.success { background-color: var(--color-accent); }
        .toast.error { background-color: var(--color-error); }
        .toast.warning { background-color: #f39c12; }

        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(10px); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 23, 41, 0.8); z-index: 10000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 12px; width: 450px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid var(--color-accent); }

        /* Loading spinner */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17,23,41,0.85); z-index: 99999; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 50px; height: 50px; border: 5px solid #262E48; border-top-color: var(--color-accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #fff; font-size: 18px; }

        @media print {
            body { background: white; color: black; overflow: visible; height: auto; }
            #sidebar, #login-view, .section-title, .print-controls, #toast-container, .modal-overlay, .loading-overlay { display: none !important; }
            #app-view, #content { display: block !important; padding: 0; margin: 0; height: auto; overflow: visible; }
            .section { display: none !important; }
            #print-section { display: block !important; }
            #print-document { padding: 0; max-width: 100%; margin: 0; box-shadow: none; }
            @page { margin: 1cm; size: A4 portrait; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù† Ø¨Û•...</div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div id="toast-container"></div>

    <!-- ==================== LOGIN ==================== -->
    <div id="login-view">
        <div class="login-box">
            <h2>Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</h2>
            <div class="input-group">
                <label>Ù†Ø§Ø²Ù†Ø§Ùˆ</label>
                <input type="text" id="login-username" placeholder="Ù†Ø§Ø²Ù†Ø§Ùˆ Ø¨Ù†ÙˆÙˆØ³Û•...">
            </div>
            <div class="input-group">
                <label>ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ</label>
                <input type="password" id="login-password" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•...">
            </div>
            <button class="btn" onclick="login()">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <p id="login-error" style="color: #e96464; margin-top: 10px; display: none;">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù‡Û•ÚµÛ•Ù†!</p>
        </div>
    </div>

    <!-- ==================== APP ==================== -->
    <div id="app-view">
        <aside id="sidebar">
            <div class="profile-area">
                <img src="https://via.placeholder.com/80" id="nav-profile-pic" class="profile-pic" alt="Ù¾Ú•Û†ÙØ§ÛŒÙ„">
                <h3 id="nav-admin-name">Ø¦Û•Ø¯Ù…ÛŒÙ†</h3>
            </div>
            <button class="nav-btn active" onclick="switchTab('dashboard', event)">ğŸ  Ù¾Û•Ú•Û•ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ</button>
            <button class="nav-btn" onclick="switchTab('add-student', event)">â• Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±</button>
            <button class="nav-btn" onclick="switchTab('add-sector', event)">ğŸ« Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú©Û•Ø±Øª</button>
            <button class="nav-btn" onclick="switchTab('list-students', event)">ğŸ‘¥ Ù„ÛŒØ³ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Û•Ú©Ø§Ù†</button>
            <button class="nav-btn" onclick="switchTab('list-sectors', event)">ğŸ“‹ Ù„ÛŒØ³ØªÛŒ Ú©Û•Ø±ØªÛ•Ú©Ø§Ù†</button>
            <button class="nav-btn" style="color: #f8cecc; border: 1px solid #f8cecc;" onclick="switchTab('print-section', event)">ğŸ–¨ï¸ Ø¨Û•Ø´ÛŒ Ù¾Ø±Ù†ØªÚ©Ø±Ø¯Ù†</button>
            <button class="nav-btn" onclick="switchTab('manage-admins', event)">ğŸ‘¤ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù†</button>
            <button class="nav-btn" onclick="switchTab('settings', event)">âš™ï¸ Ú•ÛÚ©Ø®Ø³ØªÙ†</button>
            <button class="nav-btn logout-btn" onclick="logout()">ğŸšª Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•</button>
            <button id="install-btn" class="nav-btn" onclick="installApp()"
                style="display:none; background:#4caf50; margin-top:8px;">
                ğŸ“² Ù†ØµØ¨Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù†Ø§Ù…Û•
            </button>
        </aside>

        <main id="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <h2 class="section-title">Ø¦Ø§Ù…Ø§Ø±Û• Ú¯Ø´ØªÛŒÛŒÛ•Ú©Ø§Ù†</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†</h3><p id="stat-students">0</p></div>
                    <div class="stat-card"><h3>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ Ú©Û•Ø±ØªÛ•Ú©Ø§Ù†</h3><p id="stat-sectors">0</p></div>
                    <div class="stat-card"><h3>Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù†</h3><p id="stat-admins">1</p></div>
                </div>
            </section>

            <!-- Add Student -->
            <section id="add-student" class="section">
                <h2 class="section-title">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛŒ Ù†ÙˆÛ</h2>

                <!-- Ø¯Û•Ø³ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± -->
                <div class="login-box" style="width: 100%; max-width: 500px; margin: 0 auto;">
                    <div class="input-group"><label>Ù†Ø§ÙˆÛŒ Ú†ÙˆØ§Ø±ÛŒ</label><input type="text" id="s-name"></div>
                    <div class="input-group"><label>Ø³ÛŒÚ•ÛŒØ§Úµ Ú©Û†Ø¯</label><input type="text" id="s-code"></div>
                    <div class="input-group"><label>Ú•Û•Ú¯Û•Ø²</label>
                        <select id="s-gender"><option value="Ù†ÛØ±">Ù†ÛØ±</option><option value="Ù…Û">Ù…Û</option></select>
                    </div>
                    <div class="input-group"><label>Ù¾Û†Ù„</label>
                        <select id="s-grade"><option value="10">Ù¡Ù </option><option value="11">Ù¡Ù¡</option><option value="12">Ù¡Ù¢</option></select>
                    </div>
                    <div class="input-group"><label>Ù‡Û†Ø¨Û•</label>
                        <select id="s-section"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select>
                    </div>
                    <button class="btn" onclick="addStudent()">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†</button>
                </div>

                <!-- Ø¨Û•Ø´ÛŒ Ø¦ÛÚ©Ø³Úµ -->
                <div style="width:100%; max-width:500px; margin: 30px auto 0; background: var(--bg-secondary); border-radius: 12px; padding: 25px;">
                    <h3 style="color: var(--color-accent); margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“Š Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú©Û†Ù…Û•ÚµÛÚ© Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø¨Û• ÙØ§ÛŒÙ„ÛŒ Ø¦ÛÚ©Ø³Úµ</h3>

                    <!-- Ø¯Ø§ÙˆÙ†Ù„Û†Ø¯ÛŒ Ù†Ù…ÙˆÙˆÙ†Û• -->
                    <button onclick="downloadExcelTemplate()" class="btn" style="background: #262E48; border: 1px solid var(--color-accent); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        â¬‡ï¸ Ø¯Ø§ÙˆÙ†Ù„Û†Ø¯ÛŒ Ù†Ù…ÙˆÙˆÙ†Û•ÛŒ Ø¦ÛÚ©Ø³Úµ
                    </button>

                    <!-- Ù†Ø§Ø­ÛŒÛ•ÛŒ Ø¯Ø±Ø§Ù¾ -->
                    <div id="excel-drop-zone"
                         ondrop="handleExcelDrop(event)" ondragover="event.preventDefault()"
                         onclick="document.getElementById('excel-file-input').click()"
                         style="border: 2px dashed var(--color-accent); border-radius: 10px; padding: 35px 20px;
                                text-align: center; cursor: pointer; color: var(--text-muted); transition: 0.3s;">
                        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“‚</div>
                        <div>ÙØ§ÛŒÙ„ÛŒ Ø¦ÛÚ©Ø³Úµ Ø¦ÛØ±Û• Ø¨Ú©ÛØ´Û• ÛŒØ§Ù† Ú©Ù„ÛŒÚ© Ø¨Ú©Û•</div>
                        <small style="font-size: 13px; margin-top: 8px; display: block; color: #6466E9;">.xlsx</small>
                    </div>
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display:none" onchange="handleExcelFile(this.files[0])">

                    <!-- Ù¾ÛØ´Ø¨ÛŒÙ†ÛŒ -->
                    <div id="excel-preview" style="display:none; margin-top: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap: wrap; gap: 10px;">
                            <span id="excel-count-text" style="color: #4caf50; font-weight: bold;"></span>
                            <button class="btn" onclick="importExcelStudents()" style="width:auto; padding: 10px 20px; margin:0; background: #4caf50;">
                                âœ… Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†
                            </button>
                        </div>
                        <div style="overflow-x: auto; max-height: 220px; overflow-y: auto; border-radius: 8px;">
                            <table class="data-table" id="excel-preview-table">
                                <thead><tr><th>Ù†Ø§Ùˆ</th><th>Ú©Û†Ø¯</th><th>Ú•Û•Ú¯Û•Ø²</th><th>Ù¾Û†Ù„</th><th>Ù‡Û†Ø¨Û•</th><th>Ø¯Û†Ø®</th></tr></thead>
                                <tbody id="excel-preview-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add Sector -->
            <section id="add-sector" class="section">
                <h2 class="section-title">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú©Û•Ø±ØªÛŒ Ù†ÙˆÛ</h2>
                <div class="login-box" style="width: 100%; max-width: 500px; margin: 0 auto;">
                    <div class="input-group"><label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ú©Û•Ø±Øª</label><input type="text" id="c-number"></div>
                    <div class="input-group"><label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ú©ÙˆØ±Ø³ÛŒ Ø¨Û• Ù¾Ø§Ù†ÛŒ (Ø³ØªÙˆÙˆÙ†)</label><input type="number" id="c-width" value="3"></div>
                    <div class="input-group"><label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ú©ÙˆØ±Ø³ÛŒ Ø¨Û• Ø¯Ø±ÛÚ˜ÛŒ (Ú•ÛŒØ²)</label><input type="number" id="c-length" value="5"></div>
                    <button class="btn" onclick="addSector()">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†</button>
                </div>
            </section>

            <!-- List Students -->
            <section id="list-students" class="section">
                <h2 class="section-title">Ù„ÛŒØ³ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Û•Ú©Ø§Ù†</h2>
                <div class="table-container">
                    <div class="filter-area">
                        <input type="text" id="filter-search" placeholder="Ú¯Û•Ú•Ø§Ù† Ø¨Û•Ù¾ÛÛŒ Ù†Ø§Ùˆ ÛŒØ§Ù† Ú©Û†Ø¯..." onkeyup="renderStudents()">
                        <select id="filter-grade" onchange="renderStudents()">
                            <option value="all">Ù‡Û•Ù…ÙˆÙˆ Ù¾Û†Ù„Û•Ú©Ø§Ù†</option><option value="10">Ù¡Ù </option><option value="11">Ù¡Ù¡</option><option value="12">Ù¡Ù¢</option>
                        </select>
                        <select id="filter-section" onchange="renderStudents()">
                            <option value="all">Ù‡Û•Ù…ÙˆÙˆ Ù‡Û†Ø¨Û•Ú©Ø§Ù†</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Ù†Ø§Ùˆ</th><th>Ú©Û†Ø¯</th><th>Ú•Û•Ú¯Û•Ø²</th><th>Ù¾Û†Ù„ Ùˆ Ù‡Û†Ø¨Û•</th><th>Ú©Û•Ø±Øª</th><th>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th></tr></thead>
                        <tbody id="students-tbody"></tbody>
                    </table>
                </div>
            </section>

            <!-- List Sectors -->
            <section id="list-sectors" class="section">
                <h2 class="section-title">Ù„ÛŒØ³ØªÛŒ Ú©Û•Ø±ØªÛ•Ú©Ø§Ù†</h2>
                <div class="sectors-grid" id="sectors-container"></div>
            </section>

            <!-- Print Section -->
            <section id="print-section" class="section">
                <h2 class="section-title">Ø¦Ø§Ù…Ø§Ø¯Û•Ú©Ø±Ø¯Ù†ÛŒ Ú©Û•Ø±ØªÛ•Ú©Ø§Ù† Ø¨Û† Ù¾Ø±Ù†Øª</h2>
                <div class="print-controls">
                    <label>Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†ÛŒ Ú©Û•Ø±Øª Ø¨Û† Ù¾Ø±Ù†Øª:</label>
                    <select id="print-sector-select" onchange="generatePrintLayout()"><option value="">Ú©Û•Ø±ØªÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option></select>
                    <button class="btn" style="width: 150px; margin: 0;" onclick="window.print()">ğŸ–¨ï¸ Ù¾Ø±Ù†Øª Ø¨Ú©Û•</button>
                </div>

                <div id="print-document" style="display: none;">
                    <div class="doc-header">
                        <h2>Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛŒ Ù¾ÛŒØ´Û•ÛŒÛŒ Ø²Ø§Ù†Ø³ØªÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±</h2>
                        <h3>ØªØ§Ù‚ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù†ÛŒÙˆÛ•ÛŒ ÙˆÛ•Ø±Ø²ÛŒ ÛŒÛ•Ú©Û•Ù…</h3>
                        <h3>Ø³Ø§ÚµÛŒ Ø®ÙˆÛÙ†Ø¯Ù† Ù¢Ù Ù¢Ù¥ - Ù¢Ù Ù¢Ù¦</h3>
                    </div>
                    <div class="doc-subheader">
                        <div class="box-green">Ú©Û•Ø±ØªÛŒ <span id="p-sector-id">--</span></div>
                        <div class="box-yellow">Ú˜Ù…Ø§Ø±Û•ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± : <span id="p-student-count">0</span></div>
                    </div>
                    <table class="doc-table" id="p-table-body"></table>
                    <div class="doc-footer">
                        <div class="footer-box manager-box">Ú©Ø§Ù†ÛŒØ§Ø± Ø¹Ø«Ù…Ø§Ù† Ø¹Ù„ÛŒ<br>Ø¨Û•Ú•ÛÙˆÛ•Ø¨Û•Ø±</div>
                        <div class="footer-box">
                            Ù¾Û†Ù„ÛŒ Ø¯Û• ÛŒÛ•Ù… / <span id="p-count-10">0</span><br>
                            Ù¾Û†Ù„ÛŒ ÛŒØ§Ù†Ø²Û• ÛŒÛ•Ù… / <span id="p-count-11">0</span><br>
                            Ù¾Û†Ù„ÛŒ Ø¯ÙˆØ§Ù†Ø²Û• ÛŒÛ•Ù… / <span id="p-count-12">0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Manage Admins -->
            <section id="manage-admins" class="section">
                <h2 class="section-title">Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù†</h2>
                <!-- Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†ÛŒ Ù†ÙˆÛ -->
                <div class="login-box" style="width:100%; max-width:500px; margin: 0 auto 30px;">
                    <h3 style="color: var(--color-accent); margin-bottom: 20px;">â• Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†ÛŒ Ù†ÙˆÛ</h3>
                    <div class="input-group"><label>Ù†Ø§Ø²Ù†Ø§Ùˆ</label><input type="text" id="new-admin-username" placeholder="Ù†Ø§Ø²Ù†Ø§Ùˆ..."></div>
                    <div class="input-group"><label>ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ</label><input type="password" id="new-admin-password" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ..."></div>
                    <div class="input-group"><label>Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¾Ú•Û†ÙØ§ÛŒÙ„</label><input type="text" id="new-admin-pic" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û• (Ø¦Ø§Ø±Û•Ø²ÙˆÙˆÛŒ)..."></div>
                    <div class="input-group"><label>Ø¦Û•Ø¯Ù…ÛŒÙ† ÛŒØ§Ù† Ø³ÙˆÙˆÙ¾Û•Ø± Ø¦Û•Ø¯Ù…ÛŒÙ†</label>
                        <select id="new-admin-role">
                            <option value="admin">Ø¦Û•Ø¯Ù…ÛŒÙ†</option>
                            <option value="superadmin">Ø³ÙˆÙˆÙ¾Û•Ø± Ø¦Û•Ø¯Ù…ÛŒÙ†</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addNewAdmin()">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
                </div>
                <!-- Ù„ÛŒØ³ØªÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù† -->
                <div class="table-container">
                    <h3 style="color: var(--color-accent); margin-bottom: 15px;">ğŸ‘¥ Ù„ÛŒØ³ØªÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù†</h3>
                    <table class="data-table">
                        <thead><tr><th>ÙˆÛÙ†Û•</th><th>Ù†Ø§Ø²Ù†Ø§Ùˆ</th><th>Ø¦Û•Ø¯Ù…ÛŒÙ†</th><th>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th></tr></thead>
                        <tbody id="admins-tbody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section">
                <h2 class="section-title">Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù†ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</h2>
                <div class="login-box" style="width: 100%; max-width: 500px; margin: 0 auto;">
                    <div class="input-group"><label>Ù†Ø§Ø²Ù†Ø§ÙˆÛŒ Ù†ÙˆÛ</label><input type="text" id="set-username"></div>
                    <div class="input-group"><label>ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù†ÙˆÛ</label><input type="password" id="set-password"></div>
                    <div class="input-group"><label>Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¾Ú•Û†ÙØ§ÛŒÙ„</label><input type="text" id="set-pic" placeholder="Ù„ÛŒÙ†Ú©ÛÚ©ÛŒ ÙˆÛÙ†Û• Ø¯Ø§Ø¨Ù†Û..."></div>
                    <button class="btn" onclick="saveSettings()">Ú¯Û†Ú•ÛŒÙ†</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
 // ====================================================
        //  âš™ï¸  SUPABASE CONFIG  â€” Ø¦Û•Ù…Ø§Ù†Û• Ø¨Ú¯Û†Ú•Û• Ø¨Û• ÛŒÛ•Ú©Û•Ú©Ø§Ù†ÛŒ Ø®Û†Øª
        // ====================================================
        const SUPABASE_URL = 'https://qmbiujjbfeknlxludfdu.supabase.co';   // â† URL Û•Ú©Û•Øª
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYml1ampiZmVrbmx4bHVkZmR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjM2OTUsImV4cCI6MjA4NzA5OTY5NX0.n6KgoNWx6ygKQBJbzkvLbT7tXSR08J7jZR1OjkSL2VE';  // â† anon key Û•Ú©Û•Øª
        // ====================================================

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Ø¯Ø§ØªØ§ÛŒ Ø­Ø§ÙÛŒØ²Û•
        let db = {
            admin: { username: 'admin', password: 'admin', pic: 'https://via.placeholder.com/80' },
            students: [],
            sectors: []
        };

        // ---------- Loading ----------
        function showLoading(msg = 'Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù† Ø¨Û•...') {
            document.querySelector('.loading-text').innerText = msg;
            document.getElementById('loading-overlay').classList.add('show');
        }
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }

        // ---------- Toast ----------
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'âœ…' : (type === 'error' ? 'âŒ' : 'âš ï¸');
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ---------- Modal ----------
        function closeModal() {
            document.getElementById('custom-modal').style.display = 'none';
        }

        // ---------- Load all data from Supabase ----------
        async function loadAllData() {
            showLoading('Ø¯Ø§ØªØ§Ú©Ø§Ù† Ø¯Û•Ú¯ÛŒØ±Ø¯Ø±ÛÙ†...');
            try {
                const { data: adminRows } = await sb.from('admin').select('*').eq('id', 1).single();
                if (adminRows) db.admin = adminRows;
                const { data: students, error: sErr } = await sb.from('students').select('*');
                if (sErr) throw sErr;
                db.students = students || [];
                const { data: sectors, error: cErr } = await sb.from('sectors').select('*');
                if (cErr) throw cErr;
                db.sectors = sectors || [];
            } catch (e) {
                showToast('Ù‡Û•ÚµÛ• Ù„Û• Ú©Û†Ù†ÛÚ©Ø´Ù†: ' + e.message, 'error');
                console.error(e);
            }
            hideLoading();
        }

        // ---------- Show App (shared) ----------
        function showApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-view').classList.add('shown');
            document.getElementById('nav-admin-name').innerText = db.admin.username;
            document.getElementById('nav-profile-pic').src = db.admin.pic || 'https://via.placeholder.com/80';
            updateDashboard();
            renderStudents();
            renderSectors();
            updatePrintDropdown();
        }

        // ---------- Auto-login on page load ----------
        window.addEventListener('load', async () => {
            const saved = sessionStorage.getItem('logged_in');
            if (saved === 'true') {
                showLoading('Ø¯Ø§ØªØ§Ú©Ø§Ù† Ø¯Û•Ú¯ÛŒØ±Ø¯Ø±ÛÙ†...');
                await loadAllData();
                showApp();
                showToast('Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØªÛ•ÙˆÛ•! âœ…', 'success');
            }
        });

        // ---------- Login ----------
        async function login() {
            let u = document.getElementById('login-username').value.trim();
            let p = document.getElementById('login-password').value.trim();

            showLoading('Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•...');
            await loadAllData();

            if (u === db.admin.username && p === db.admin.password) {
                sessionStorage.setItem('logged_in', 'true');
                showApp();
                showToast('Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ú†ÙˆÙˆÛŒØªÛ• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•', 'success');
            } else {
                hideLoading();
                document.getElementById('login-error').style.display = 'block';
            }
        }

        // ---------- Logout ----------
        function logout() {
            sessionStorage.removeItem('logged_in');
            document.getElementById('app-view').classList.remove('shown');
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').style.display = 'none';
            showToast('Ù„Û• Ø¨Û•Ø±Ù†Ø§Ù…Û•Ú©Û• Ú†ÙˆÙˆÛŒØªÛ• Ø¯Û•Ø±Û•ÙˆÛ•', 'warning');
        }

        // ---------- Tab Switch ----------
        function switchTab(tabId, e) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if (e && e.currentTarget) e.currentTarget.classList.add('active');
            if (tabId === 'manage-admins') renderAdmins();
        }

        // ---------- Dashboard ----------
        function updateDashboard() {
            document.getElementById('stat-students').innerText = db.students.length;
            document.getElementById('stat-sectors').innerText = db.sectors.length;
        }

        // ---------- Add Student ----------
        async function addStudent() {
            let name    = document.getElementById('s-name').value.trim();
            let code    = document.getElementById('s-code').value.trim();
            let gender  = document.getElementById('s-gender').value;
            let grade   = document.getElementById('s-grade').value;
            let section = document.getElementById('s-section').value;

            if (!name || !code) return showToast('ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ùˆ Ùˆ Ú©Û†Ø¯ Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'error');
            if (db.students.find(s => s.code === code)) return showToast('Ø¦Û•Ù… Ø³ÛŒÚ•ÛŒØ§Úµ Ú©Û†Ø¯Û• Ù¾ÛØ´ØªØ± Ø¯Ø§Ø®Úµ Ú©Ø±Ø§ÙˆÛ•!', 'error');

            showLoading('Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø²ÛŒØ§Ø¯ Ø¯Û•Ú©Ø±ÛØª...');
            const newStudent = { name, code, gender, grade, section, sectorId: null, seatIndex: null };
            const { data, error } = await sb.from('students').insert([newStudent]).select().single();
            if (error) {
                hideLoading();
                return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error');
            }
            db.students.push(data);
            updateDashboard();
            renderStudents();
            updatePrintDropdown();
            hideLoading();
            showToast('Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø§!', 'success');
            document.getElementById('s-name').value = '';
            document.getElementById('s-code').value = '';
        }

        // ---------- Add Sector ----------
        async function addSector() {
            let num    = document.getElementById('c-number').value.trim();
            let width  = document.getElementById('c-width').value;
            let length = document.getElementById('c-length').value;

            if (!num || !width || !length) return showToast('ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù†ÛŒ Ú©Û•Ø±Øª Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'error');
            if (db.sectors.find(s => s.id === num)) return showToast('Ø¦Û•Ù… Ú˜Ù…Ø§Ø±Û•ÛŒ Ú©Û•Ø±ØªÛ• Ù¾ÛØ´ØªØ± Ø¯Ø§Ø®Úµ Ú©Ø±Ø§ÙˆÛ•!', 'error');

            showLoading('Ú©Û•Ø±Øª Ø²ÛŒØ§Ø¯ Ø¯Û•Ú©Ø±ÛØª...');
            const newSector = { id: num, width: parseInt(width), length: parseInt(length) };
            const { error } = await sb.from('sectors').insert([newSector]);
            if (error) {
                hideLoading();
                return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error');
            }
            db.sectors.push(newSector);
            updateDashboard();
            renderSectors();
            updatePrintDropdown();
            hideLoading();
            showToast('Ú©Û•Ø±Øª Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø§!', 'success');
        }

        // ---------- Render Students ----------
        function renderStudents() {
            let search  = document.getElementById('filter-search').value;
            let grade   = document.getElementById('filter-grade').value;
            let section = document.getElementById('filter-section').value;

            let filtered = db.students.filter(s => {
                let matchSearch  = s.name.includes(search) || s.code.includes(search);
                let matchGrade   = grade   === 'all' ? true : s.grade   === grade;
                let matchSection = section === 'all' ? true : s.section === section;
                return matchSearch && matchGrade && matchSection;
            });

            filtered.sort((a, b) => a.name.localeCompare(b.name, 'ku'));

            let tbody = document.getElementById('students-tbody');
            tbody.innerHTML = '';
            filtered.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.code}</td>
                        <td>${s.gender}</td>
                        <td>${s.grade} - ${s.section}</td>
                        <td>${s.sectorId ? 'Ú©Û•Ø±ØªÛŒ ' + s.sectorId : 'Ø¯ÛŒØ§Ø±ÛŒÙ†Û•Ú©Ø±Ø§ÙˆÛ•'}</td>
                        <td style="display:flex; gap:6px; justify-content:center;">
                            <button onclick="openEditStudentModal('${s.id}')"
                                style="padding:6px 12px; background:#3498db; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
                                âœï¸ Ú¯Û†Ú•ÛŒÙ†
                            </button>
                            <button onclick="deleteStudent('${s.id}')"
                                style="padding:6px 12px; background:#e96464; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
                                ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•
                            </button>
                        </td>
                    </tr>`;
            });
        }

        // ---------- Render Sectors ----------
        function renderSectors() {
            let container = document.getElementById('sectors-container');
            container.innerHTML = '';
            db.sectors.forEach(sec => {
                let totalCapacity  = sec.width * sec.length;
                let currentStudents = db.students.filter(s => s.sectorId === sec.id).length;
                container.innerHTML += `
                    <div class="sector-card">
                        <h4>Ú©Û•Ø±ØªÛŒ ${sec.id}</h4>
                        <div class="sector-details">
                            <span>Ù¾Ø§Ù†ÛŒ (Ø³ØªÙˆÙˆÙ†): ${sec.width}</span>
                            <span>Ø¯Ø±ÛÚ˜ÛŒ (Ú•ÛŒØ²): ${sec.length}</span>
                        </div>
                        <div class="sector-details">
                            <span>Ø¬ÛÚ¯Ø§ÛŒ Ú¯Ø´ØªÛŒ: ${totalCapacity}</span>
                            <span>Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛŒ ØªÛØ¯Ø§ÛŒÛ•: ${currentStudents}</span>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn" onclick="openSectorEditModal('${sec.id}')" style="flex:1; background:#262E48; border:1px solid #6466E9; margin:0;">âœï¸ Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ</button>
                            <button class="btn" onclick="deleteSector('${sec.id}')" style="flex:1; background:#e96464; margin:0;">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                        </div>
                    </div>`;
            });
        }

        // ---------- Sector Edit Modal ----------
        function openSectorEditModal(id) {
            let sec = db.sectors.find(s => s.id === id);
            let modal   = document.getElementById('custom-modal');
            let content = document.getElementById('modal-body');
            content.innerHTML = `
                <h3 style="color: var(--color-accent); margin-bottom: 20px; font-size: 22px;">Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ù„Û• Ú©Û•Ø±ØªÛŒ ${id}</h3>
                <div class="input-group">
                    <label style="color: white; font-size: 16px;">Ú˜Ù…Ø§Ø±Û•ÛŒ Ù†ÙˆÛÛŒ Ú©ÙˆØ±Ø³ÛŒ Ø¨Û• Ù¾Ø§Ù†ÛŒ</label>
                    <input type="number" id="edit-w" value="${sec.width}" style="font-size: 16px;">
                </div>
                <div class="input-group">
                    <label style="color: white; font-size: 16px;">Ú˜Ù…Ø§Ø±Û•ÛŒ Ù†ÙˆÛÛŒ Ú©ÙˆØ±Ø³ÛŒ Ø¨Û• Ø¯Ø±ÛÚ˜ÛŒ</label>
                    <input type="number" id="edit-l" value="${sec.length}" style="font-size: 16px;">
                </div>
                <button class="btn" style="background: #3498db; margin-top: 15px; font-size: 16px;" onclick="distributeForSector('${id}')">
                    ğŸ”„ Ø¯Ø§Ø¨Û•Ø´Ú©Ø±Ø¯Ù†ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø¨Û† Ø¦Û•Ù… Ú©Û•Ø±ØªÛ•
                </button>
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button class="btn" style="background: #e96464; flex: 1; font-size: 18px;" onclick="closeModal()">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                    <button class="btn" style="background: #4caf50; flex: 1; font-size: 18px;" onclick="saveSectorEdit('${id}')">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†</button>
                </div>`;
            modal.style.display = 'flex';
        }

        // ---------- Save Sector Edit ----------
        async function saveSectorEdit(id) {
            let newW = parseInt(document.getElementById('edit-w').value);
            let newL = parseInt(document.getElementById('edit-l').value);
            if (!newW || !newL) return showToast('ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'error');

            showLoading('Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ø¯Û•Ú©Ø±ÛØª...');
            const { error } = await sb.from('sectors').update({ width: newW, length: newL }).eq('id', id);
            if (error) {
                hideLoading();
                return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error');
            }
            let sec = db.sectors.find(s => s.id === id);
            sec.width  = newW;
            sec.length = newL;
            renderSectors();
            closeModal();
            hideLoading();
            showToast('Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ù„Û• Ú©Û•Ø±ØªÛ•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§', 'success');
        }

        // ---------- Distribute Students For Sector (SMART) ----------
        async function distributeForSector(id) {
            let newW = parseInt(document.getElementById('edit-w').value);
            let newL = parseInt(document.getElementById('edit-l').value);
            if (!newW || !newL) return showToast('ØªÚ©Ø§ÛŒÛ• Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'error');

            let sec = db.sectors.find(s => s.id === id);
            sec.width  = newW;
            sec.length = newL;

            let unassigned = db.students.filter(s => !s.sectorId);
            if (unassigned.length === 0) return showToast('Ù‡ÛŒÚ† Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛÚ© Ù†ÛŒÛŒÛ• Ú©Û• Ú©Û•Ø±ØªÛŒ Ù†Û•Ø¨ÛØª Ø¨Û† Ø¯Ø§Ø¨Û•Ø´Ú©Ø±Ø¯Ù†!', 'warning');

            let capacity     = sec.width * sec.length;  // Ú©Û†ÛŒ Ø¬ÛÚ¯Ø§Ú©Ø§Ù†
            let totalRows    = sec.length;               // Ú˜Ù…Ø§Ø±Û•ÛŒ Ú•ÛŒØ²Û•Ú©Ø§Ù†
            let cols         = sec.width;                // Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³ØªÙˆÙˆÙ†Û•Ú©Ø§Ù†

            // ===================================================
            // ÛŒØ§Ø³Ø§Ú©Ø§Ù†ÛŒ Ø¯Ø§Ø¨Û•Ø´Ú©Ø±Ø¯Ù†ÛŒ ØªÛ•Ù„Û•Ø¨Û•Ú©Ø§Ù†:
            // Ù¡. Ù‡Û•Ø± Ú•ÛŒØ²ÛÚ© ØªÛ•Ù†Ù‡Ø§ ÛŒÛ•Ú© Ù¾Û†Ù„ (Ù¡Ù  ÛŒØ§Ù† Ù¡Ù¡ ÛŒØ§Ù† Ù¡Ù¢)
            // Ù¢. Ù„Û• Ù‡Û•Ù…Ø§Ù† Ú•ÛŒØ² Ù‡ÛŒÚ† Ø¯ÙˆÙˆ Ù‚ÙˆØªØ§Ø¨ÛŒ Ù‡Û•Ù…Ø§Ù† Ù‡Û†Ø¨Û• (A,B,C...) Ù†Û•Ø¨Ù†
            // ===================================================

            // ØªÛ•Ù„Û•Ø¨Û•Ú©Ø§Ù† Ø¨Û• Ù¾Û†Ù„ Ø¯Ø§Ø¨Û•Ø´ Ø¨Ú©Û• Ùˆ Ø¦Û•Ù… ØªÛ•Ø±ØªÛŒØ¨Ø§Ù†Û• Ø¨Û• ØªÙˆÙˆÙ†Ø¯ÛŒ ØªÛÚ©Û•Úµ Ø¨Ú©Û•
            let g10 = unassigned.filter(s => s.grade === '10').sort(() => Math.random() - 0.5);
            let g11 = unassigned.filter(s => s.grade === '11').sort(() => Math.random() - 0.5);
            let g12 = unassigned.filter(s => s.grade === '12').sort(() => Math.random() - 0.5);

            // Ù‡Û•Ø± Ú•ÛŒØ²ÛÚ© Ù¾Ú•Ø¨Ú©Û• Ø¨Û• ÛŒÛ•Ú© Ù¾Û†Ù„ØŒ Ùˆ Ù„Û•Ù†Ø§ÙˆÛŒØ§Ù†Ø¯Ø§ Ù‡ÛŒÚ† Ù‡Û†Ø¨Û•ÛŒ Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ù†Û•Ø¨ÛØª
            // Ø¦Û†Ø±Ø¯Û•Ø±ÛŒ Ú•ÛŒØ²Û•Ú©Ø§Ù†: Ù¡Ù¡ â†’ Ù¡Ù  â†’ Ù¡Ù¢ (Ø¯Û•ØªÙˆØ§Ù†ÛŒ Ø¨Ú¯Û†Ú•ÛŒ)
            let gradeQueues = [g11, g10, g12]; // Ø¦Û†Ø±Ø¯Û•Ø±ÛŒ Ù¾Û†Ù„Û•Ú©Ø§Ù† Ù„Û• Ú•ÛŒØ²Û•Ú©Ø§Ù†Ø¯Ø§
            let gradeNames  = ['11', '10', '12'];

            // grid Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û• Ø¨Û† Ú©Û•Ø±ØªÛ•Ú©Û•
            // grid[row][col] = student ÛŒØ§Ù† null
            let grid = Array.from({ length: totalRows }, () => Array(cols).fill(null));

            let totalPlaced = 0;
            let queueIndex  = 0; // Ú©Ø§Ù… queue Ù„Û•Ø³Û•Ø± Ú©Ø§Ø± Ø¯Û•Ú©Û•ÛŒÙ†

            for (let row = 0; row < totalRows && queueIndex < gradeQueues.length; row++) {
                // Ø¨Û† Ø¦Û•Ù… Ú•ÛŒØ²Û• Ø¦Û•Ù… Ù¾Û†Ù„Û• Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•
                // Ø¦Û•Ú¯Û•Ø± queue ÛŒ Ø¦Û•Ù… Ù¾Û†Ù„Û• Ø¨Û•ØªØ§Úµ Ø¨ÙˆÙˆØŒ Ø¨Ú•Û† Ø¨Û† Ù¾Û†Ù„ÛŒ Ø¯ÛŒÚ©Û•
                while (queueIndex < gradeQueues.length && gradeQueues[queueIndex].length === 0) {
                    queueIndex++;
                }
                if (queueIndex >= gradeQueues.length) break;

                let currentQueue = gradeQueues[queueIndex];
                let usedSections = new Set(); // Ù‡Û†Ø¨Û•Ú©Ø§Ù†ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡Ø§ØªÙˆÙˆ Ù„Û•Ù… Ú•ÛŒØ²Û•Ø¯Ø§

                for (let col = 0; col < cols; col++) {
                    if (currentQueue.length === 0) break;

                    // Ø¯ÙˆÛÚ˜ÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒÛ•Ú© Ú©Û• Ù‡Û†Ø¨Û•Ú©Û•ÛŒ Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ù†Û•Ø¨ÛØª Ù„Û•Ù… Ú•ÛŒØ²Û•Ø¯Ø§
                    let foundIdx = currentQueue.findIndex(s => !usedSections.has(s.section));

                    if (foundIdx === -1) {
                        // Ù‡Û•Ù…ÙˆÙˆ Ù‡Û†Ø¨Û•Ú©Ø§Ù† Ø¨Û•Ú©Ø§Ø±Ù‡Ø§ØªÙˆÙˆÙ† Ù„Û•Ù… Ú•ÛŒØ²Û•Ø¯Ø§ â€” Ø¬ÛÚ¯Ø§Ú©Û• Ø¨Û•ØªØ§Úµ Ø¨Ù‡ÛÚµÛ•
                        grid[row][col] = null;
                    } else {
                        let student = currentQueue.splice(foundIdx, 1)[0];
                        usedSections.add(student.section);
                        grid[row][col] = student;
                        totalPlaced++;
                    }
                }

                // Ø¦Û•Ú¯Û•Ø± Ø¦Û•Ù… Ú•ÛŒØ²Û• ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆØŒ queue ÛŒ Ø¦Û•Ù… Ù¾Û†Ù„Û• Ø¨Û•ØªØ§Úµ Ø¨ÙˆÙˆ
                // Ú•ÛŒØ²ÛŒ Ø¯Ø§Ù‡Ø§ØªÙˆÙˆ Ù‡Û•Ù…Ø§Ù† Ù¾Û†Ù„ Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù… Ø¯Û•Ø¨ÛØª Ø¦Û•Ú¯Û•Ø± ØªÛ•Ù„Û•Ø¨Û•ÛŒ Ù…Ø§ÙˆÛ•
                // Ø¦Û•Ú¯Û•Ø± Ù†Û•Ù…Ø§ÛŒÛ•ÙˆÛ•ØŒ Ø¨Ú•Û† Ø¨Û† Ù¾Û†Ù„ÛŒ Ø¯Ø§Ù‡Ø§ØªÙˆÙˆ
                if (currentQueue.length === 0) {
                    queueIndex++;
                }
            }

            if (totalPlaced === 0) {
                return showToast('Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ù‡ÛŒÚ† Ù‚ÙˆØªØ§Ø¨ÛŒÛ•Ú© Ø¯Ø§Ø¨Û•Ø´ Ø¨Ú©Ø±ÛØª - Ù‡Û†Ø¨Û•Ú©Ø§Ù† Ø²Û†Ø± Ø¯ÙˆÙˆØ¨Ø§Ø±Û•Ù†', 'error');
            }

            showLoading(`${totalPlaced} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø¯Ø§Ø¨Û•Ø´ Ø¯Û•Ú©Ø±ÛÙ†...`);

            // seatIndex Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û• Ø¨Û•Ù¾ÛÛŒ grid
            let toUpdate = [];
            let seatIdx  = 0;
            for (let row = 0; row < totalRows; row++) {
                for (let col = 0; col < cols; col++) {
                    let student = grid[row][col];
                    if (student) {
                        student.sectorId  = sec.id;
                        student.seatIndex = seatIdx;
                        toUpdate.push({ id: student.id, sectorId: sec.id, seatIndex: seatIdx });
                    }
                    seatIdx++;
                }
            }

            // Batch update Supabase
            for (let item of toUpdate) {
                await sb.from('students')
                    .update({ sectorId: item.sectorId, seatIndex: item.seatIndex })
                    .eq('id', item.id);
            }
            await sb.from('sectors').update({ width: newW, length: newL }).eq('id', id);

            renderStudents();
            renderSectors();
            closeModal();
            hideLoading();

            let remaining = unassigned.length - totalPlaced;
            if (remaining > 0) {
                showToast(`${totalPlaced} Ø¯Ø§Ø¨Û•Ø´ Ú©Ø±Ø§ âœ… â€” ${remaining} Ù…Ø§ÙˆÛ•Ù† (Ø¬ÛÚ¯Ø§ Ù†Û•Ù…Ø§ÙˆÛ• ÛŒØ§Ù† Ù‡Û†Ø¨Û•ÛŒ Ø¯ÙˆÙˆØ¨Ø§Ø±Û•)`, 'warning');
            } else {
                showToast(`Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ ${totalPlaced} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ú©Ø±Ø§Ù†Û• Ú©Û•Ø±ØªÛŒ ${sec.id} âœ…`, 'success');
            }
        }

        // ---------- Print Dropdown ----------
        function updatePrintDropdown() {
            let select = document.getElementById('print-sector-select');
            select.innerHTML = '<option value="">Ú©Û•Ø±ØªÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>';
            db.sectors.forEach(sec => {
                select.innerHTML += `<option value="${sec.id}">Ú©Û•Ø±ØªÛŒ ${sec.id}</option>`;
            });
        }

        function getGradeName(grade) {
            if (grade === '10') return 'Ø¯Û•';
            if (grade === '11') return 'ÛŒØ§Ù†Ø²Û•';
            if (grade === '12') return 'Ø¯ÙˆØ§Ù†Ø²Û•';
            return grade;
        }

        // ---------- Print Layout (BUG FIXED) ----------
        function generatePrintLayout() {
            let sectorId = document.getElementById('print-sector-select').value;
            let docArea  = document.getElementById('print-document');
            if (!sectorId) { docArea.style.display = 'none'; return; }

            docArea.style.display = 'block';
            let sec             = db.sectors.find(s => s.id === sectorId);
            let studentsInSector = db.students.filter(s => s.sectorId === sectorId);
            studentsInSector.sort((a, b) => a.seatIndex - b.seatIndex);

            document.getElementById('p-sector-id').innerText     = sec.id;
            document.getElementById('p-student-count').innerText = studentsInSector.length;

            let c10 = studentsInSector.filter(s => s.grade === '10').length;
            let c11 = studentsInSector.filter(s => s.grade === '11').length;
            let c12 = studentsInSector.filter(s => s.grade === '12').length;
            document.getElementById('p-count-10').innerText = c10;
            document.getElementById('p-count-11').innerText = c11;
            document.getElementById('p-count-12').innerText = c12;

            let tbody    = document.getElementById('p-table-body');
            let tableHTML = '';
            let sIndex   = 0;

            for (let r = 0; r < sec.length; r++) {
                tableHTML += '<tr>';
                for (let c = 0; c < sec.width; c++) {
                    // âœ… Ù‡Û•ÚµÛ•Ú©Û• Ú†Ø§ÙƒÙƒØ±Ø§: [sIndex] Ø²ÛŒØ§Ø¯Ú©Ø±Ø§
                    let student = studentsInSector[sIndex];
                    if (student) {
                        let gradeClass = `grade-${student.grade}`;
                        let gradeText  = getGradeName(student.grade);
                        tableHTML += `
                            <td class="${gradeClass}">
                                ${student.name}<br>
                                Ø³Ú•ÛŒØ§Úµ / ${student.code}<br>
                                Ù¾Û†Ù„ÛŒ ${gradeText}(${student.section})
                            </td>`;
                        sIndex++;
                    } else {
                        tableHTML += `<td class="grade-empty">Ø¨Û•ØªØ§Úµ</td>`;
                    }
                }
                tableHTML += '</tr>';
            }
            tbody.innerHTML = tableHTML;
        }

        // ---------- Save Settings ----------
        async function saveSettings() {
            let u   = document.getElementById('set-username').value.trim();
            let p   = document.getElementById('set-password').value.trim();
            let pic = document.getElementById('set-pic').value.trim();

            let updates = {};
            if (u)   updates.username = u;
            if (p)   updates.password = p;
            if (pic) updates.pic      = pic;

            if (Object.keys(updates).length === 0) return showToast('Ù‡ÛŒÚ† Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛŒÛ•Ú© Ù†Û•Ù†ÙˆÙˆØ³Ø±Ø§', 'warning');

            showLoading('Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ø¯Û•Ú©Ø±ÛØª...');
            const { error } = await sb.from('admin').update(updates).eq('id', 1);
            if (error) {
                hideLoading();
                return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error');
            }
            if (u)   db.admin.username = u;
            if (p)   db.admin.password = p;
            if (pic) db.admin.pic      = pic;

            document.getElementById('nav-admin-name').innerText = db.admin.username;
            if (pic) document.getElementById('nav-profile-pic').src = db.admin.pic;
            hideLoading();
            showToast('Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù† Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ú¯Û†Ú•Ø¯Ø±Ø§Ù†!', 'success');
        }

        // ==================== Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± ====================

        function openEditStudentModal(id) {
            let s = db.students.find(st => st.id === id);
            if (!s) return;
            let modal   = document.getElementById('custom-modal');
            let content = document.getElementById('modal-body');
            content.innerHTML = `
                <h3 style="color: var(--color-accent); margin-bottom: 20px; font-size: 20px;">âœï¸ Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±</h3>
                <div class="input-group">
                    <label style="color:white;">Ù†Ø§ÙˆÛŒ Ú†ÙˆØ§Ø±ÛŒ</label>
                    <input type="text" id="edit-s-name" value="${s.name}">
                </div>
                <div class="input-group">
                    <label style="color:white;">Ø³ÛŒÚ•ÛŒØ§Úµ Ú©Û†Ø¯</label>
                    <input type="text" id="edit-s-code" value="${s.code}">
                </div>
                <div class="input-group">
                    <label style="color:white;">Ú•Û•Ú¯Û•Ø²</label>
                    <select id="edit-s-gender">
                        <option value="Ù†ÛØ±" ${s.gender==='Ù†ÛØ±'?'selected':''}>Ù†ÛØ±</option>
                        <option value="Ù…Û"  ${s.gender==='Ù…Û' ?'selected':''}>Ù…Û</option>
                    </select>
                </div>
                <div class="input-group">
                    <label style="color:white;">Ù¾Û†Ù„</label>
                    <select id="edit-s-grade">
                        <option value="10" ${s.grade==='10'?'selected':''}>Ù¡Ù </option>
                        <option value="11" ${s.grade==='11'?'selected':''}>Ù¡Ù¡</option>
                        <option value="12" ${s.grade==='12'?'selected':''}>Ù¡Ù¢</option>
                    </select>
                </div>
                <div class="input-group">
                    <label style="color:white;">Ù‡Û†Ø¨Û•</label>
                    <select id="edit-s-section">
                        ${['A','B','C','D','E'].map(x=>`<option value="${x}" ${s.section===x?'selected':''}>${x}</option>`).join('')}
                    </select>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn" style="background:#e96464; flex:1;" onclick="closeModal()">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                    <button class="btn" style="background:#4caf50; flex:1;" onclick="saveStudentEdit('${id}')">âœ… Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†</button>
                </div>`;
            modal.style.display = 'flex';
        }

        async function saveStudentEdit(id) {
            let name    = document.getElementById('edit-s-name').value.trim();
            let code    = document.getElementById('edit-s-code').value.trim();
            let gender  = document.getElementById('edit-s-gender').value;
            let grade   = document.getElementById('edit-s-grade').value;
            let section = document.getElementById('edit-s-section').value;

            if (!name || !code) return showToast('Ù†Ø§Ùˆ Ùˆ Ú©Û†Ø¯ Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'error');

            // check duplicate code (ignore own)
            let dup = db.students.find(s => s.code === code && s.id !== id);
            if (dup) return showToast('Ø¦Û•Ù… Ú©Û†Ø¯Û• Ø¨Û† Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛÚ©ÛŒ ØªØ± Ø¨Û•Ú©Ø§Ø± Ø¯Û•Ù‡ÛÙ†Ø±ÛØª!', 'error');

            showLoading('Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ø¯Û•Ú©Ø±ÛØª...');
            const { error } = await sb.from('students')
                .update({ name, code, gender, grade, section })
                .eq('id', id);
            if (error) { hideLoading(); return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error'); }

            let s = db.students.find(st => st.id === id);
            s.name = name; s.code = code; s.gender = gender; s.grade = grade; s.section = section;

            renderStudents();
            closeModal();
            hideLoading();
            showToast('Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ú¯Û†Ú•Ø¯Ø±Ø§ âœ…', 'success');
        }

        async function deleteStudent(id) {
            let s = db.students.find(st => st.id === id);
            if (!s) return;
            let modal   = document.getElementById('custom-modal');
            let content = document.getElementById('modal-body');
            content.innerHTML = `
                <div style="font-size:50px; margin-bottom:15px;">âš ï¸</div>
                <h3 style="margin-bottom:15px;">Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ:</h3>
                <p style="color: var(--color-accent); font-size:18px; margin-bottom:25px;">${s.name}</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:#555; flex:1;" onclick="closeModal()">Ù†Û•Ø®ÛØ±</button>
                    <button class="btn" style="background:#e96464; flex:1;" onclick="confirmDeleteStudent('${id}')">Ø¨Û•ÚµÛ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                </div>`;
            modal.style.display = 'flex';
        }

        async function confirmDeleteStudent(id) {
            showLoading('Ø³Ú•ÛŒÙ†Û•ÙˆÛ•...');
            const { error } = await sb.from('students').delete().eq('id', id);
            if (error) { hideLoading(); return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error'); }
            db.students = db.students.filter(s => s.id !== id);
            updateDashboard();
            renderStudents();
            closeModal();
            hideLoading();
            showToast('Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø³Ú•Ø§ÛŒÛ•ÙˆÛ• âœ…', 'success');
        }

        // ==================== Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú©Û•Ø±Øª ====================

        async function deleteSector(id) {
            let studentsInSector = db.students.filter(s => s.sectorId === id);
            let modal   = document.getElementById('custom-modal');
            let content = document.getElementById('modal-body');
            content.innerHTML = `
                <div style="font-size:50px; margin-bottom:15px;">âš ï¸</div>
                <h3 style="margin-bottom:10px;">Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú©Û•Ø±ØªÛŒ ${id}ØŸ</h3>
                ${studentsInSector.length > 0
                    ? `<p style="color:#f39c12; margin-bottom:20px;">âš ï¸ ${studentsInSector.length} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ù„Û•Ù… Ú©Û•Ø±ØªÛ•Ø¯Ø§Ù† â€” Ú©Û•Ø±ØªÛ•Ú©Û•ÛŒØ§Ù† Ù„Ø§Ø¨Ø±Ø¯Û•ÙˆÛ• Ø¯Û•Ø¨ÛØª</p>`
                    : `<p style="color:var(--text-muted); margin-bottom:20px;">Ù‡ÛŒÚ† Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛÚ© Ù„Û•Ù… Ú©Û•Ø±ØªÛ•Ø¯Ø§ Ù†ÛŒÛŒÛ•</p>`
                }
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:#555; flex:1;" onclick="closeModal()">Ù†Û•Ø®ÛØ±</button>
                    <button class="btn" style="background:#e96464; flex:1;" onclick="confirmDeleteSector('${id}')">Ø¨Û•ÚµÛ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                </div>`;
            modal.style.display = 'flex';
        }

        async function confirmDeleteSector(id) {
            showLoading('Ú©Û•Ø±Øª Ø³Ú•ÛŒÙ†Û•ÙˆÛ•...');
            // Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†ÛŒ Ø¦Û•Ù… Ú©Û•Ø±ØªÛ• Ú©Û•Ø±ØªÛŒ Ù†Û•Ø¨ÛØª
            for (let s of db.students.filter(st => st.sectorId === id)) {
                await sb.from('students').update({ sectorId: null, seatIndex: null }).eq('id', s.id);
                s.sectorId  = null;
                s.seatIndex = null;
            }
            const { error } = await sb.from('sectors').delete().eq('id', id);
            if (error) { hideLoading(); return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error'); }
            db.sectors = db.sectors.filter(s => s.id !== id);
            updateDashboard();
            renderSectors();
            renderStudents();
            updatePrintDropdown();
            closeModal();
            hideLoading();
            showToast(`Ú©Û•Ø±ØªÛŒ ${id} Ø³Ú•Ø§ÛŒÛ•ÙˆÛ• âœ…`, 'success');
        }

        // ==================== Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù† ====================

        async function renderAdmins() {
            showLoading('Ø¦Û•Ø¯Ù…ÛŒÙ†Û•Ú©Ø§Ù† Ø¯Û•Ú¯ÛŒØ±Ø¯Ø±ÛÙ†...');
            const { data, error } = await sb.from('admin').select('*');
            hideLoading();
            if (error) return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error');

            let tbody = document.getElementById('admins-tbody');
            tbody.innerHTML = '';
            (data || []).forEach(a => {
                tbody.innerHTML += `<tr>
                    <td><img src="${a.pic || 'https://via.placeholder.com/40'}"
                        style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--color-accent)"></td>
                    <td>${a.username}</td>
                    <td>${a.role || 'admin'}</td>
                    <td>
                        <button onclick="deleteAdmin(${a.id}, '${a.username}')"
                            style="padding:6px 14px; background:#e96464; color:#fff; border:none; border-radius:6px; cursor:pointer;">
                            ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•
                        </button>
                    </td>
                </tr>`;
            });
        }

        async function addNewAdmin() {
            let username = document.getElementById('new-admin-username').value.trim();
            let password = document.getElementById('new-admin-password').value.trim();
            let pic      = document.getElementById('new-admin-pic').value.trim();
            let role     = document.getElementById('new-admin-role').value;

            if (!username || !password) return showToast('Ù†Ø§Ø²Ù†Ø§Ùˆ Ùˆ ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'error');

            showLoading('Ø¦Û•Ø¯Ù…ÛŒÙ† Ø²ÛŒØ§Ø¯ Ø¯Û•Ú©Ø±ÛØª...');
            const { error } = await sb.from('admin').insert([{
                username, password,
                pic: pic || 'https://via.placeholder.com/80',
                role
            }]);
            if (error) { hideLoading(); return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error'); }

            document.getElementById('new-admin-username').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('new-admin-pic').value      = '';
            await renderAdmins();
            hideLoading();
            showToast(`Ø¦Û•Ø¯Ù…ÛŒÙ†ÛŒ ${username} Ø²ÛŒØ§Ø¯Ú©Ø±Ø§ âœ…`, 'success');
        }

        async function deleteAdmin(id, username) {
            if (id === 1) return showToast('Ù†Û•ØªÙˆØ§Ù†Ø±ÛØª Ø¦Û•Ø¯Ù…ÛŒÙ†ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ Ø¨Ø³Ú•Ø¯Ø±ÛØªÛ•ÙˆÛ•!', 'error');
            let modal   = document.getElementById('custom-modal');
            let content = document.getElementById('modal-body');
            content.innerHTML = `
                <div style="font-size:50px; margin-bottom:15px;">âš ï¸</div>
                <h3 style="margin-bottom:15px;">Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†:</h3>
                <p style="color:var(--color-accent); font-size:18px; margin-bottom:25px;">${username}</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:#555; flex:1;" onclick="closeModal()">Ù†Û•Ø®ÛØ±</button>
                    <button class="btn" style="background:#e96464; flex:1;" onclick="confirmDeleteAdmin(${id})">Ø¨Û•ÚµÛ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                </div>`;
            modal.style.display = 'flex';
        }

        async function confirmDeleteAdmin(id) {
            showLoading('Ø³Ú•ÛŒÙ†Û•ÙˆÛ•...');
            const { error } = await sb.from('admin').delete().eq('id', id);
            if (error) { hideLoading(); return showToast('Ù‡Û•ÚµÛ•: ' + error.message, 'error'); }
            await renderAdmins();
            closeModal();
            hideLoading();
            showToast('Ø¦Û•Ø¯Ù…ÛŒÙ† Ø³Ú•Ø§ÛŒÛ•ÙˆÛ• âœ…', 'success');
        }

        // ==================== EXCEL IMPORT ====================

        // SheetJS CDN Ø¨Û•Ú©Ø§Ø±Ø¯ÛØª Ø¨Û† Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¦ÛÚ©Ø³Úµ
        let excelParsedStudents = [];

        function downloadExcelTemplate() {
            // Ù†Ù…ÙˆÙˆÙ†Û•ÛŒ CSV Ø¯Ø±ÙˆØ³Øª Ø¯Û•Ú©Ø§Øª ÙˆÛ•Ú© Ø®ÛØ±Ø§ÛŒÛŒ
            const rows = [
                ['Ù†Ø§ÙˆÛŒ Ú†ÙˆØ§Ø±ÛŒ', 'Ø³ÛŒÚ•ÛŒØ§Úµ Ú©Û†Ø¯', 'Ú•Û•Ú¯Û•Ø²', 'Ù¾Û†Ù„', 'Ù‡Û†Ø¨Û•'],
                ['Ø¦Û•Ø­Ù…Û•Ø¯ Ú©Û•Ø±ÛŒÙ…', '1001', 'Ù†ÛØ±', '10', 'A'],
                ['Ø³Ø§Ø±Ø§ Ø¹Ù„ÛŒ', '1002', 'Ù…Û', '11', 'B'],
            ];
            // Ø¨Ù†Ø§Ø³ÛÙ†ÛŒÙ† Ú©Û• Ú†Û†Ù† xlsx Ø¨Ø³Ø§Ø²ÛŒÙ† Ø¨Û•Ø¨Û library, Ø¨Û• CSV Ø¯Û•Ù†ÛØ±ÛŒÙ†
            const csvContent = '\uFEFF' + rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href     = url;
            a.download = 'Ù†Ù…ÙˆÙˆÙ†Û•ÛŒ_Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Ù†Ù…ÙˆÙˆÙ†Û•Ú©Û• Ø¯Ø§ÙˆÙ†Ù„Û†Ø¯ Ú©Ø±Ø§! CSV Ø¨Û• Ø¦ÛÚ©Ø³Úµ Ø¨Ú©Û•Ø±Û•ÙˆÛ•', 'success');
        }

        function handleExcelDrop(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) handleExcelFile(file);
        }

        function handleExcelFile(file) {
            if (!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['xlsx','xls','csv'].includes(ext)) {
                return showToast('ØªÛ•Ù†Ù‡Ø§ ÙØ§ÛŒÙ„ÛŒ .xlsx ÛŒØ§Ù† .csv Ù‚Ø¨ÙˆÚµ Ø¯Û•Ú©Ø±ÛØª', 'error');
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (ext === 'csv') {
                        parseCSV(e.target.result);
                    } else {
                        // SheetJS Ø¨Ø§Ø± Ø¯Û•Ú©Û•ÛŒÙ† Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ©ÛŒ
                        if (typeof XLSX === 'undefined') {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                            script.onload = () => {
                                const wb = XLSX.read(e.target.result, { type: 'array' });
                                const ws = wb.Sheets[wb.SheetNames[0]];
                                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                                processExcelData(data);
                            };
                            document.head.appendChild(script);
                        } else {
                            const wb = XLSX.read(e.target.result, { type: 'array' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                            processExcelData(data);
                        }
                    }
                } catch(err) {
                    showToast('Ù‡Û•ÚµÛ• Ù„Û• Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙØ§ÛŒÙ„Û•Ú©Û•: ' + err.message, 'error');
                }
            };
            if (ext === 'csv') {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(text) {
            // Ø¨Ú•ÛŒ BOM
            text = text.replace(/^\uFEFF/, '');
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const data  = lines.map(l => l.split(',').map(c => c.trim().replace(/^"|"$/g, '')));
            processExcelData(data);
        }

        function processExcelData(data) {
            if (data.length < 2) return showToast('ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Û•ØªØ§ÚµÛ•!', 'error');

            // Ú•ÛŒØ²ÛŒ Ø³Û•Ø±ÙˆÙˆÚ©Û• Ø¨ÛØ¯Û•Ù†Ú¯ Ø¨ÛØª
            const rows = data.slice(1);
            excelParsedStudents = [];
            const tbody = document.getElementById('excel-preview-tbody');
            tbody.innerHTML = '';
            const validGenders  = ['Ù†ÛØ±','Ù…Û'];
            const validGrades   = ['10','11','12'];
            const validSections = ['A','B','C','D','E'];

            rows.forEach((row, idx) => {
                if (!row || row.length < 5) return;
                const [name, code, gender, grade, section] = row.map(v => String(v || '').trim());
                if (!name && !code) return;

                let errors = [];
                if (!name)                           errors.push('Ù†Ø§Ùˆ Ù†ÛŒÛŒÛ•');
                if (!code)                           errors.push('Ú©Û†Ø¯ Ù†ÛŒÛŒÛ•');
                if (!validGenders.includes(gender))  errors.push('Ú•Û•Ú¯Û•Ø² Ù‡Û•ÚµÛ•ÛŒÛ•');
                if (!validGrades.includes(grade))    errors.push('Ù¾Û†Ù„ Ù‡Û•ÚµÛ•ÛŒÛ•');
                if (!validSections.includes(section)) errors.push('Ù‡Û†Ø¨Û• Ù‡Û•ÚµÛ•ÛŒÛ•');
                if (db.students.find(s => s.code === code)) errors.push('Ú©Û†Ø¯ Ø¯ÙˆÙˆØ¨Ø§Ø±Û•ÛŒÛ•');

                const valid = errors.length === 0;
                if (valid) {
                    excelParsedStudents.push({ name, code, gender, grade, section, sectorId: null, seatIndex: null });
                }

                tbody.innerHTML += `<tr>
                    <td>${name}</td><td>${code}</td><td>${gender}</td><td>${grade}</td><td>${section}</td>
                    <td style="color: ${valid ? '#4caf50' : '#e96464'}; font-weight: bold;">
                        ${valid ? 'âœ… Ø¨Ø§Ø´Û•' : 'âŒ ' + errors.join('ØŒ ')}
                    </td>
                </tr>`;
            });

            const validCount = excelParsedStudents.length;
            document.getElementById('excel-count-text').innerText =
                `${validCount} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛŒ Ø¨Ø§Ø´ Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•`;
            document.getElementById('excel-preview').style.display = 'block';

            if (validCount === 0) showToast('Ù‡ÛŒÚ† Ú•ÛŒØ²ÛÚ©ÛŒ Ø¨Ø§Ø´ Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•ØŒ Ú†Û•Ú©ÛŒ ÙØ§ÛŒÙ„Û•Ú©Û•Øª Ø¨Ú©Û•', 'warning');
        }

        async function importExcelStudents() {
            if (excelParsedStudents.length === 0) return showToast('Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±ÛŒ Ø¨Ø§Ø´ Ù†ÛŒÛŒÛ• Ø¨Û† Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†', 'warning');

            showLoading(`${excelParsedStudents.length} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø²ÛŒØ§Ø¯ Ø¯Û•Ú©Ø±ÛÙ†...`);

            // Ø¨Û• batch Ú©Ø±Ø¯Ù† - Ù‡Û•Ø± Ø¬Ø§Ø±ÛÚ© Ù¡Ù  Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± ØªØ§ Supabase Ù‡Û•ÚµÛ• Ù†Û•Ø¯Ø§Øª
            const BATCH_SIZE = 10;
            let allInserted = [];
            let failCount = 0;

            try {
                for (let i = 0; i < excelParsedStudents.length; i += BATCH_SIZE) {
                    const batch = excelParsedStudents.slice(i, i + BATCH_SIZE);
                    document.querySelector('.loading-text').innerText =
                        `${Math.min(i + BATCH_SIZE, excelParsedStudents.length)} / ${excelParsedStudents.length} Ø²ÛŒØ§Ø¯ Ø¯Û•Ú©Ø±ÛØª...`;

                    const { data, error } = await sb.from('students').insert(batch).select();
                    if (error) {
                        console.error('Batch error:', error);
                        failCount += batch.length;
                    } else {
                        allInserted.push(...(data || batch));
                    }
                }
            } catch (e) {
                hideLoading();
                return showToast('Ù‡Û•ÚµÛ•ÛŒ Ú©Û†Ù†ÛÚ©Ø´Ù†: ' + e.message + ' â€” URL Ùˆ KEY ÛŒ Supabase Ø¨Ú†Û•Ú©', 'error');
            }

            db.students.push(...allInserted);
            updateDashboard();
            renderStudents();
            updatePrintDropdown();

            // Ú•ÛŒØ³ÛØª
            document.getElementById('excel-preview').style.display = 'none';
            document.getElementById('excel-file-input').value = '';
            excelParsedStudents = [];

            hideLoading();
            if (failCount > 0) {
                showToast(`${allInserted.length} Ø²ÛŒØ§Ø¯Ú©Ø±Ø§ØŒ ${failCount} Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ù†Û•Ø¨ÙˆÙˆ`, 'warning');
            } else {
                showToast(`Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ ${allInserted.length} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± Ø²ÛŒØ§Ø¯Ú©Ø±Ø§Ù†! âœ…`, 'success');
            }
        }

        // ==================== PWA Service Worker ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('SW registered'))
                    .catch(e => console.log('SW error:', e));
            });
        }

        // Ù†ÛŒØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ Ø¯ÙˆÚ¯Ù…Û•ÛŒ Ù†ØµØ¨Ú©Ø±Ø¯Ù†
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Ø¯ÙˆÚ¯Ù…Û•ÛŒ Ù†ØµØ¨Ú©Ø±Ø¯Ù† Ù†ÛŒØ´Ø§Ù† Ø¨Ø¯Û•
            const installBtn = document.getElementById('install-btn');
            if (installBtn) installBtn.style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.getElementById('install-btn').style.display = 'none';
                });
            }
        }

    </script>
</body>
</html>